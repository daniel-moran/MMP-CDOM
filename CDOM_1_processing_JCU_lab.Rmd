---
title: "CDOM data batches - collate the data, check for drift and apply corrections"
autput: html_document
author: "Daniel Moran"
organisation: "AIMS"
date:   "14/04/2021"
update: 20/05/2020 to include drift corrections and apply absorbant coefficient calcs to corrected data
update: 03/12/2020 to apply modeled data over a narrower range. 350-680nm. objective is to provide a better modeled fit.
update: 06/01/2021 to change scan plots with wavelgth on the x axis instead of deltaLambda. and collate CDOM443 values from modeled outputs based on the corrected data
update: 29/04/2021 review by Alex Macadam to bring up to R version 4.0.5 and RStudio version 1.4.1106 and format for RMarkdown. 
update: 07/04/2021 to include R2 value for each scan/model.
update: 17/05/2021 removed unused code and added R2 values to graph headers
update: 18/05/2021 added clear environment in line 33
update: 06/07/2021 combined modelled443 and R2 into the model443 outputs csv. moved this file to outputs/data.
update: 10/02/2023 added additional details to the upfront instructions.
update: 10/05/2023 changed the theme for the blank driftplots from "theme_minimal" to "theme_gray" due to problems we were having black plot backgrounds being output on some user laptops - not sure what the issue was but perhaps related to user settings somehow - "theme_gray" seems to have solved the problem.
update: 04/03/2025 arbitrary version update before start  of 2024-25 conversions
update: 17/06/2025 moved this script to github repo MMP-CDOM/main and renamed to remove now redundant version control (no longer required with move to github). Confirmed this script compatible with R version 4.3.1 (2023-06-16 ucrt) -- "Beagle Scouts" and RStudio 2025.05.1+513 "Mariposa Orchid" Release (ab7c1bc795c7dcff8f26215b832a3649a19fc16c, 2025-06-01) for windows.

This script is confirmed to be compatible with R version 4.3.1 and Rstudio version 2025.05.1+513
Combine multiple .csv files from a batch of UV-Vis spec outputs into a single data table and convert to absorption coefficients
Run this script first
User must: 
: IN WINDOWS EXPLORER
: -pull latest version of the code from github repo MMP-CDOM/main. See Daniel Moran for help with this if you need assistance accessing the repo
: -copy script to the working directory and add batch information to the script filename eg. "CDOM_1_processing_b20241218_FTZ400-412.Rmd"
: -create "extra" folder in the working directory and move run notes, a backup of the raw data and any additional files to this folder.
: IN the R SCRIPT FOR THIS BATCH
: -reset R session (windows CTRL+SHIFT+F10)
: -change the wd
: -change the file string information in "pwd" used for generating filenames to reflect the actual parent folder for the wd. (update to pwd generally only will need to be done for each years' processing if you are not moving the data.)
N.B.
data files should only include files that have been auto-exported from the Shimadzu UV-1900 UV-Vis spec.
R for windows does not like '\' so you will need to replace all the '\' in the filepath with '/'

copy file path here:
R:\Lagoon_WQ\results\CDOM\2024-25 report\JCF\CDOM-JCU_J25-0046
---

## Set the working directory
###MUST change '\' to '/' in path
```{r, include=FALSE}
rm(list=ls())
setwd("R:/Lagoon_WQ/results/CDOM/2024-25 report/JCF/CDOM-JCU_J25-0046")
wd <- getwd()
pwd<- "R:/Lagoon_WQ/results/CDOM/2024-25 report/JCF"
```


## Create some folders in the wd for saving outputs
```{r, include= FALSE}
{dir.create(file.path(wd,"outputs"))
dir.create(file.path(wd,"outputs","plots"))
dir.create(file.path(wd,"outputs","data"))
}
```

## create lists of all files in the wd
```{r, include= FALSE}
library(rlist)
{file_list <- list.files(wd, pattern=".csv", full.names=TRUE)
}
```


## Import the data from CSV. 
```{r, include= FLASE}
library(tidyverse)

CDOM_comp <- read.csv(file_list, header =  TRUE)
names(CDOM_comp)
CDOM_comp <- dplyr::rename(CDOM_comp, 'Wavelength_nm' = 'Wavelength.nm.')
CDOM_comp <- dplyr::rename(CDOM_comp, 'MilliQ_start' = 'Milli.Q')
CDOM_comp <- dplyr::rename(CDOM_comp, 'MilliQ_end' = 'Milli.Q.1')
names(CDOM_comp)

```

### plot blank curves to look for drift - we are only plotting this to eyeball the control scans and ensure we are happy with the JCU output at a gross level - they only have start and end blank scans and the supplied data does not include timestamps or other analytical metadata so drift corrections are not practical

## 1st create a dataframe with milliQ blanks only
```{r, include= FLASE}

list <- names(CDOM_comp)  
batch <- str_remove(wd, pwd)
batch <- str_remove(batch, "/")
blank_list <- list[grep("illi",list)]
samples_list <- setdiff(list, blank_list)
samples_list <- setdiff(samples_list, Wavelength_nm)
  
CDOM_long <- pivot_longer(CDOM_comp, cols = MilliQ_start:MilliQ_end, names_to = 'Sample', values_to = 'Absorbance', cols_vary = "fastest")


#filter to show  half-nanometer increments only
filter_vals <- seq(250, 750, by=0.5)
names(CDOM_long)
CDOM_long <- filter(CDOM_long, Wavelength_nm %in% filter_vals)
rm(filter_vals)

#create df of the blanks 
CDOM_blanks <- filter(CDOM_long, Sample %in% blank_list)

## sample as factor, order the data by start to end of the batch
CDOM_blanks
sapply(CDOM_blanks, class)
temp2 <- factor(CDOM_blanks$Sample, levels = blank_list)
CDOM_blanks$Sample <- temp2
rm(temp2)
sapply(CDOM_blanks, class)
levels(CDOM_blanks$Sample)



```

## plot the data in CDOM_blanks, organise by samples, to look for drift
```{r, include= FLASE}
{library(ggplot2)
driftplot <- ggplot(CDOM_blanks, aes(x = Wavelength_nm, y = Absorbance, colour = Sample)) + 
  geom_line(linewidth=0.1) +
  ylab('Absorbance') +
  xlab('Wavelength_nm') +
  scale_y_continuous(minor_breaks = NULL, breaks=seq(-0.02,0.02,0.01),limits=c(-0.02,0.02)) +
  scale_x_continuous(minor_breaks = NULL, breaks=seq(250,750,50), limits=c(250,750)) +
  theme_gray() 
driftplot
}

#save a copy of the driftplot as a .jpg
{plotpath <- file.path(wd,"outputs","plots")
batch <- str_remove(wd, pwd)
batch <- str_remove(batch, "/")
plotfilename <- paste(batch,"_driftplot", ".jpg",sep = "")
ggsave(plotfilename, path=plotpath)
}
```
#convert back to wide format and save a copy of the raw absorbance scan data. note no drift corrected data is generated
```{r, include= FLASE}
{
CDOM_matrix <- spread(CDOM_long, key = Sample, value = Absorbance)

## write matrix data table to file
datasave <- paste(wd, "/outputs/data/", batch, "_raw", ".csv", sep="")
write.csv(CDOM_matrix,file=datasave,row.names=F)
}

```

#run the conversion to ACDOM

#save the abrorbance coefficients

#produce and save plots for each sample

















  
# re-write of code for calculating absorption coefficient etc (above) but using drift corrected data...
# CDOM data conversions - code from "CALCULATIONS" script by Christian Lomborg, adapted by Daniel Moran to batches of CDOM scans from Shimadzu UV-1900 UV-Vis spec...
## Outputs (for each sample):
## CDOM data conversion using "internal correction approach" to give absorbtion coefficient at each wavelength (Acdom). (see Lønborg & Álvarez-Salgado / Deep-Sea Research 85 (2014) 35-46)
## Factor 23.03 in calculating Acdom converts from decadic to natural logarithms and considers the cell path-length (10cm) (see Lønborg & Álvarez-Salgado / Deep-Sea Research 85 (2014) 3546)
## Note. if a different cell path legth is used (anything other than 10cm) than the factor will need to be adjusted. factor=2.303/path length in meters
## spectral slope (S). see C. A. Stedmon and S. Markager / Limnol. Oceanogr., 46(8), 2001, 2087-2093
## plots of fit between observed and modelled data (based on S) 
  
```{r, include= FLASE} 

rsq <- function(x, y) summary(lm(y~x))$r.squared

  for (f in samples_list) {
    if (!exists("CDOM_conv")){
      CDOM_conv <- c()
      CDOM_conv2 <- c()
      CDOM_conv3 <- c()
    }
    if (exists("CDOM_conv")){ 
      dat <- CDOM_long[Sample == f, Absorbance, by=Wavelength_nm]
      dat$Sample = factor(f)
      dat2 <- c()
      dat2$Sample = factor(f)
      MeanAbs600_750 <- mean(subset(dat, Wavelength_nm >=600 & Wavelength_nm <=750)$Absorbance, na.rm=TRUE)
      dat2$MeanAbs600_750_raw <- MeanAbs600_750
      dat$Acdom = 23.03 * (dat$Absorbance - MeanAbs600_750)
      
      Abs350 = dat$Acdom[dat$Wavelength_nm==350]
      dat2$Abs350 = Abs350
      deltaLambda = dat$Wavelength_nm - dat$Wavelength_nm[dat$Wavelength_nm==350]
      dat$deltaLambda <- deltaLambda
      Abs443 = dat$Acdom[dat$Wavelength_nm==443]
      dat2$Abs443 = Abs443
      
      dat.nls <- nls(Acdom ~ Abs350*exp(-S*deltaLambda),
                     data=dat, start=list(S=1), control=nls.control(maxiter=1000))
      summary(dat.nls)
      dat2$S<-coef(dat.nls)

      xs <- seq(350,680,by=0.5) - dat$Wavelength_nm[dat$Wavelength_nm==350]
      newdata <- data.frame(deltaLambda=xs)
      fit <- predict(dat.nls, newdata=newdata)
      newdata <- cbind(newdata, fit)
      newdata$Sample = factor(f)
      newdata$wavelength_nm <- newdata$deltaLambda + 350
      
      GoF_temp <- newdata
      data1 <- filter(dat, Wavelength_nm >= 350.0 & Wavelength_nm <= 680.0)
      GoF_temp$Acdom = data1$Acdom
      r_squared <- rsq(GoF_temp$Acdom, GoF_temp$fit)
      
      plotpath <- file.path(wd,"outputs","plots")
      plotfilename <- paste(dat2$Sample,".jpg",sep = "")
      print(ggplot(dat, aes(y=Acdom, x=Wavelength_nm)) + geom_line()+
              geom_line(data=newdata, aes(y=fit, x=wavelength_nm), color='red')+ggtitle(paste(dat2$Sample,': S=',dat2$S, ', ', 'R^2=', r_squared))+
              scale_y_continuous(expression(A[cdom]))+
              scale_x_continuous(expression(Wavelength (nm))))
      ggsave(plotfilename, path=plotpath)
      
      CDOM_conv <- rbind(CDOM_conv, dat) 
      dat2 <- as.data.frame(dat2,row.names=seq())
      CDOM_conv2 <- rbind(CDOM_conv2, dat2) 
      CDOM_conv3 <- rbind(CDOM_conv3, newdata) 
      rm(dat)
      rm(dat2)
      rm(newdata)
      rm(dat.nls)
      rm(fit)
      rm(xs)
      rm(MeanAbs600_750)
      rm(Abs350)
      rm(deltaLambda)
      rm(Abs443)
      rm(GoF_temp)
      rm(r_squared)
      rm(data1)
    }
  }
  
```  


## create an object containing the new directory and name of compiled data to be saved
```{r, include= FLASE}
  {
    datasave2 <- paste("outputs/data/",(gsub(pwd,"",wd)),"_factors",".csv", sep="")
    datasave4 <- paste("outputs/data/",(gsub(pwd,"",wd)),"_Acdom",".csv", sep="")
    
    ## write data table to file
    write.csv(CDOM_conv2,file=datasave2, row.names=F)
    
    ## remove the deltaLambda and Abs. column from the compiled data
    CDOM_conv4 <- CDOM_conv
    CDOM_conv4$deltaLambda <- NULL
    CDOM_conv4$Abs_corr <- NULL
    
    ## create a matrix for CDOM_conv data (i.e. convert to 'wide' format)
    library(tidyr)
    #to be looked at below (why have to be mean?)
    ACDOM_matrix <- pivot_wider(CDOM_conv4, names_from = Sample, values_from = Acdom, values_fn = mean)
   
    ## write matrix data to file
    write.csv(ACDOM_matrix,file=datasave4, row.names=F) 
  }
```  


##calculate Rsquared for GoF (loop)
```{r, include= FLASE}
dat_GoF <- CDOM_conv3
dat_GoF$deltaLambda <- NULL
temp <- filter(CDOM_conv4, Wavelength_nm >= 350.0 & Wavelength_nm <= 680.0)
dat_GoF$Acdom <- temp$Acdom
dat_GoF <- dat_GoF[c("Sample", "wavelength_nm", "Acdom", "fit")]
temp <- NULL
rsq <- function(x, y) summary(lm(y~x))$r.squared

for (z in samples_list) {
    if (!exists("GoF_temp")){
      GoF_temp <- c()
      datR2 <- data.frame()
      }
    if (exists("GoF_temp")){ 
    dat <- c()
    GoF_temp <- filter(dat_GoF, Sample==z)
    dat$Sample = factor(z)
    r_squared <- rsq(GoF_temp$Acdom, GoF_temp$fit)
    dat$r_squared <- r_squared
    datR2 <- rbind(datR2, dat)
    }
}

#rm(dat)
#rm(GoF_temp)
#rm(r_squared)

#print datR2
#datasaveR2 <- paste("outputs/data/",(gsub(pwd,"",wd)),"_GoF",".csv", sep="")
#write.csv(datR2,file=datasaveR2,row.names=F)
```

##calculate CDOM_443 from modeled data
```{r, include= FLASE}
CDOM_conv3$wavelength_nm <- CDOM_conv3$deltaLambda + 350
{
  model_443 <- filter(CDOM_conv3, wavelength_nm == 443.0)
  model_443 <- group_by(model_443, Sample)
  model_443$model_443 <- model_443$fit
  model_443$wavelength_nm <- NULL
  model_443$fit <- NULL
  model_443$deltaLambda <- NULL
  names(model_443)
  is.data.table(model_443)
  setnames(model_443, "Sample", "sample") #change the column name in baseline from "Sample" to "sample"
  #print CDOM_443
  model_443<- cbind(model_443, datR2$r_squared)
  colnames(model_443)<- c("Sample", "model_443","r_squared")
  datasavemodel443 <- paste("outputs/data/",(gsub(pwd,"",wd)),"_model443",".csv", sep="")
  write.csv(model_443,file=datasavemodel443,row.names=F)
}
```